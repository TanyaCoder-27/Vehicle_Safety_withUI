{% extends 'base.html' %}

{% block title %}Upload Video - Vehicle Speed Detection{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex flex-column flex-md-row align-items-md-center mb-4">
                <i class="fas fa-cloud-upload-alt fa-2x text-primary me-md-3 mb-3 mb-md-0 align-self-center align-self-md-start"></i>
                <div class="text-center text-md-start">
                    <h1 class="mb-1">Upload Traffic Video</h1>
                    <p class="lead mb-0">Upload your traffic video for speed detection and license plate recognition analysis.</p>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0"><i class="fas fa-file-video me-2"></i>Video Upload Form</h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-heading me-2 text-primary"></i>Video Title
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-tag text-primary"></i>
                                </span>
                                {{ form.title }}
                            </div>
                            <div class="form-text">Enter a descriptive title for your traffic video</div>
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block mt-2">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.title.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.video_file.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-film me-2 text-primary"></i>Video File
                            </label>
                            <div class="upload-area p-4 mb-3 text-center" id="dropZone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                <h5>Drag & Drop your video here</h5>
                                <p class="text-muted mb-3">or</p>
                                <div class="d-grid">
                                    <label for="{{ form.video_file.id_for_label }}" class="btn btn-outline-primary">
                                        <i class="fas fa-folder-open me-2"></i>Browse Files
                                    </label>
                                </div>
                                {{ form.video_file }}
                                <div class="mt-3 text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Supported formats: MP4, AVI, MOV. Maximum file size: 500MB
                                </div>
                            </div>
                            <div id="fileInfo" class="d-none alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-video me-3 fa-2x"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0" id="fileName">filename.mp4</h6>
                                        <span class="text-muted small" id="fileSize">0 MB</span>
                                    </div>
                                    <button type="button" class="btn-close" id="removeFile"></button>
                                </div>
                            </div>
                            
                            <!-- Video Preview Section -->
                            <div id="videoPreviewContainer" class="mt-4 d-none">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-light py-3">
                                        <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Video Preview</h6>
                                    </div>
                                    <div class="card-body p-0">
                                        <video id="videoPreview" class="w-100" controls></video>
                                    </div>
                                </div>
                            </div>
                            {% if form.video_file.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.video_file.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid d-md-flex gap-2 justify-content-md-between">
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary order-md-1 order-2">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg order-md-2 order-1 mb-2 mb-md-0">
                                <i class="fas fa-upload me-2"></i>Upload Video
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>What happens after upload?</h5>
                </div>
                <div class="card-body p-0">
                    <div class="process-timeline">
                        <div class="process-step">
                            <div class="process-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span class="process-number">1</span>
                            </div>
                            <div class="process-content">
                                <h6>Upload</h6>
                                <p class="text-muted">Your video will be uploaded and saved securely</p>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="process-icon">
                                <i class="fas fa-play-circle"></i>
                                <span class="process-number">2</span>
                            </div>
                            <div class="process-content">
                                <h6>Process</h6>
                                <p class="text-muted">Click "Process Video" from your dashboard to start analysis</p>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="process-icon">
                                <i class="fas fa-tachometer-alt"></i>
                                <span class="process-number">3</span>
                            </div>
                            <div class="process-content">
                                <h6>Speed Detection</h6>
                                <p class="text-muted">Our AI will detect vehicles and calculate their speeds</p>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="process-icon">
                                <i class="fas fa-id-card"></i>
                                <span class="process-number">4</span>
                            </div>
                            <div class="process-content">
                                <h6>License Plate Recognition</h6>
                                <p class="text-muted">License plates will be automatically recognized</p>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="process-icon">
                                <i class="fas fa-file-download"></i>
                                <span class="process-number">5</span>
                            </div>
                            <div class="process-content">
                                <h6>Results</h6>
                                <p class="text-muted">Results will be available as processed video and CSV report</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('id_video_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFile = document.getElementById('removeFile');
    const uploadForm = document.getElementById('uploadForm');
    const videoPreview = document.getElementById('videoPreview');
    const videoPreviewContainer = document.getElementById('videoPreviewContainer');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropZone.classList.add('border-primary');
    }
    
    function unhighlight() {
        dropZone.classList.remove('border-primary');
    }
    
    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length) {
            fileInput.files = files;
            updateFileInfo(files[0]);
        }
    }
    
    // Handle file input change
    fileInput.addEventListener('change', function() {
        if (this.files.length) {
            updateFileInfo(this.files[0]);
        }
    });
    
    function updateFileInfo(file) {
        // Check if file is a video
        const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime'];
        if (!allowedTypes.includes(file.type)) {
            alert('Please select a valid video file (MP4, AVI, MOV)!');
            fileInput.value = '';
            resetVideoPreview();
            return;
        }
        
        // Check file size (max 500MB)
        if (file.size > 500 * 1024 * 1024) {
            alert('File size exceeds 500MB limit!');
            fileInput.value = '';
            resetVideoPreview();
            return;
        }
        
        fileName.textContent = file.name;
        fileSize.textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
        fileInfo.classList.remove('d-none');
        
        // Create video preview
        createVideoPreview(file);
    }
    
    function createVideoPreview(file) {
        // Create a blob URL for the video file
        const videoURL = URL.createObjectURL(file);
        
        // Set the video source and show the preview
        videoPreview.src = videoURL;
        videoPreviewContainer.classList.remove('d-none');
        
        // Add event listener to revoke the blob URL when the video is loaded
        videoPreview.onloadeddata = function() {
            console.log('Video preview loaded successfully');
        };
        
        // Add event listener for errors
        videoPreview.onerror = function() {
            console.error('Error loading video preview');
            resetVideoPreview();
        };
    }
    
    function resetVideoPreview() {
        // Hide the video preview container
        videoPreviewContainer.classList.add('d-none');
        
        // Reset the video source
        if (videoPreview.src) {
            URL.revokeObjectURL(videoPreview.src);
            videoPreview.src = '';
        }
        
        // Hide file info
        fileInfo.classList.add('d-none');
    }
    
    // Remove file
    removeFile.addEventListener('click', function() {
        fileInput.value = '';
        resetVideoPreview();
    });
    
    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('Please select a video file to upload');
        }
    });
});
</script>
{% endblock %}
